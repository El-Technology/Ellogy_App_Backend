name: Build and deploy API Gateway
on:
  push:
    branches:
      - develop
    paths:
      - OcelotApiGateway/**
      - .github/workflows/DeployGateway.yml
      
env:
  ENVNAME: ${{ vars.ENVNAME }} 
  AZURE_WEBAPP_NAME: "EllogyApiGateway"

jobs:
  build_api_gateway:
    env:  
      MICROSERVICE_NAME: 'api_gateway'
      PROJECT_PATH: './OcelotApiGateway/'
      CONTEXT: '.'
      DOCKERFILEPATH: './OcelotApiGateway/Dockerfile'
      
    outputs:
      MicroserviceName: ${{ steps.build-n-push.outputs.MicroserviceName }}
      MicroserviceImage: ${{ steps.build-n-push.outputs.MicroserviceImage }}
        
    runs-on: ubuntu-latest
    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Build and push image of API Gateway
        id: build-n-push
        uses: ./.github/actions/Build-n-push
        with: 
          MicroserviceName: ${{ env.MICROSERVICE_NAME }}
          Environment: ${{ env.ENVNAME }}
          ProjectPath: ${{ env.PROJECT_PATH }}
          Context: ${{ env.CONTEXT }}
          DockerfilePath: ${{ env.DOCKERFILEPATH }}
          Token: ${{ secrets.GITHUB_TOKEN }}
          
  deploy:
    runs-on: ubuntu-latest

    needs: build_api_gateway

    env:
      URL: ${{ needs.build_api_gateway.outputs.MicroserviceImage }}

    steps:
      - name: Update secret on PR deployment slot
        uses: Azure/cli@v1.0.7
        with:
          inlineScript: az webapp config container set
            --name EllogyApiGateway 
            --resource-group AI_SmartGoals
            --docker-registry-server-user ${{ github.actor }}
            --docker-registry-server-password ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@85270a1854658d167ab239bce43949edb336fa7c
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          images: 'ghcr.io/${{ env.URL }}'
