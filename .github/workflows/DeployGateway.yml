name: Build and deploy API Gateway
on:
  push:
    branches:
      - 'customer_kahrama'
    paths:
      - OcelotApiGateway/**
      - .github/actions/**
      - .github/workflows/DeployGateway.yml

env:
  ENVNAME: ${{ vars.ENVNAME }} 
  AZURE_WEBAPP_NAME: 'EllogyGateway-kahrama'

  ACR_SERVER: ${{ vars.ACR_SERVER_KAHRAMA }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME_KAHRAMA }}
  ACR_PASSWD: ${{ secrets.ACR_PASSWD_KAHRAMA }}

jobs:
  build_api_gateway:
    permissions: write-all
    
    env:  
      MICROSERVICE_NAME: 'api_gateway'

      PROJECT_PATH: './OcelotApiGateway/'
      DOCKERFILEPATH: './OcelotApiGateway/Dockerfile'
      CONTEXT: '.'

    outputs:
      MicroserviceName: ${{ steps.build-n-push_API-GW.outputs.MicroSRVC_Name }}
      MicroserviceImage: ${{ steps.build-n-push_API-GW.outputs.MicroSRVC_Image }}

    runs-on: ubuntu-latest
    steps:
      - name: Get Code
        uses: actions/checkout@v3

      - name: Build and push image of API Gateway
        id: build-n-push_API-GW
        uses: ./.github/actions/Build-n-push
        with: 
          Project_path: ${{ env.PROJECT_PATH }}
          Dockerfile_path: ${{ env.DOCKERFILEPATH }}
          Context: ${{ env.CONTEXT }}

          Customer_ID: kahrama
          Microservice_name: ${{ env.MICROSERVICE_NAME }}
          Environment: ${{ env.ENVNAME }}
          Image_tag_num: ${{ github.run_number }}
          
          ACR_server: ${{ env.ACR_SERVER }}
          ACR_username: ${{ env.ACR_USERNAME }}
          ACR_passwd: ${{ env.ACR_PASSWD }}

  deploy:
    runs-on: ubuntu-latest

    needs: build_api_gateway

    env:
      URL: ${{ needs.build_api_gateway.outputs.MicroserviceImage }}

    steps:
      # - name: Login to docker registry
      #   uses: docker/login-action@v2
      #   with:
      #     # registry: ghcr.io
      #     # username: ${{ github.actor }}
      #     # password: ${{ github.token }}
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ github.token }}

      - name: Login to ACR (AzureContainerRepository)
        id: container-repository
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_SERVER }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWD }}

      - name: Get WebApp/FunctionApp publish profile
        id: webapp
        uses: aliencube/publish-profile-actions@v1
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS_KAHRAMA }}
        with:
          resourceGroupName: 'rg-ellogy-dev-eastus-001'
          appName: ${{ env.AZURE_WEBAPP_NAME }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@85270a1854658d167ab239bce43949edb336fa7c
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: '${{ steps.webapp.outputs.profile }}'
          images: '${{ env.URL }}'
